<% I18n.with_locale(@locale) do %>
  <header class="header text-xs">
    <div class="flex justify-between">
      <%= image_tag("images/logo_cheyere.png") %>
      <table>
        <tbody>
          <tr>
            <th colspan="2" class="px-2 bg-gray-200 border-1 rounded rounded-b-none">
              <%= t("views.organization.completion_snapshots.invoice.title") %>
            </th>
          </tr>
          <tr>
            <th class="text-left px-2 bg-gray-200 border-1 border-t-0">
              <%= t("views.organization.completion_snapshots.invoice.number") %>
            </th>
            <td class="px-2 text-right border-1 border-t-0 border-l-0">
              <%= @invoice.number %>
            </td>
          </tr>
          <tr>
            <th class="text-left px-2 bg-gray-200 border-1 border-t-0">
              <%= t("views.organization.completion_snapshots.invoice.issue_date") %>
            </th>
            <td class="px-2 text-right border-1 border-t-0 border-l-0">
              <%= l(@invoice.issue_date, format: :short) %>
            </td>
          </tr>
          <tr>
            <th class="text-left px-2 bg-gray-200 border-1 border-t-0">
              <%= t("views.organization.completion_snapshots.invoice.delivery_date") %>
            </th>
            <td class="px-2 text-right border-1 border-t-0 border-l-0">
              <%= l(@invoice.delivery_date, format: :short) %>
            </td>
          </tr>
          <tr>
            <th class="text-left px-2 bg-gray-200 border-1 border-t-0">
              <%= t("views.organization.completion_snapshots.invoice.payment_term.days_label") %>
            </th>
            <td class="px-2 text-right border-1 border-t-0 border-l-0">
              <%= t("views.organization.completion_snapshots.invoice.payment_term.days_value",
                  count: @invoice.payload.dig("payment_term", "days")) %>
            </td>
          </tr>
          <tr>
            <th class="text-left px-2 bg-gray-200 border-1 border-t-0 rounded-bl">
              <%= t("views.organization.completion_snapshots.invoice.payment_term.accepted_methods_label",
                  count: @invoice.payload.dig("payment_term", "accepted_methods").length) %>
            </th>
            <td class="px-2 text-right border-1 border-t-0 border-l-0 rounded-br">
              <%= @invoice.payload.dig("payment_term", "accepted_methods")
                    .map { |method| t("views.organization.completion_snapshots.invoice.payment_term.accepted_methods_value.#{method}") }
                    .join(", ") %>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </header>

  <footer class="footer text-xs ml-[-113.336px]">
    <p>
      <%= [
        t("views.organization.completion_snapshots.invoice.seller_details.legal_form.#{@invoice.payload.dig("seller", "legal_form")}",
          capital_amount: number_to_currency(@invoice.payload.dig("seller", "capital_amount"))),
        t("views.organization.completion_snapshots.invoice.seller_details.rcs",
          city: @invoice.payload.dig("seller", "rcs_city"),
          number: @invoice.payload.dig("seller", "rcs_number")),
        t("views.organization.completion_snapshots.invoice.seller_details.vat_number",
          number: @invoice.payload.dig("seller", "vat_number"))
      ].join(" - ") %>
    </p>
  </footer>

  <main class="text-xs">
    <section class="mb-8">
      <table class="mb-8 w-full">
        <tbody>
          <tr>
            <th colspan="2" class="px-2 py-0.5 bg-gray-200 rounded rounded-b-none border-1">
              <%= t("views.organization.completion_snapshots.invoice.seller_details.title") %>
            </th>
          </tr>
          <tr>
            <th class="text-left px-2 py-0.5 bg-gray-200 border-1 border-t-0">
              <%= t("views.organization.completion_snapshots.invoice.seller_details.name_label") %>
            </th>
            <td class="px-2 py-0.5 text-right border-1 border-t-0 border-l-0">
              <%= @invoice.payload.dig("seller", "name") %>
            </td>
          </tr>
          <tr>
            <th class="text-left px-2 py-0.5 bg-gray-200 border-1 border-t-0">
              <%= t("views.organization.completion_snapshots.invoice.seller_details.address_label") %>
            </th>
            <td class="px-2 py-0.5 text-right border-1 border-t-0 border-l-0">
              <%= t("views.organization.completion_snapshots.invoice.seller_details.address_value", **@invoice.payload.dig("seller", "address").symbolize_keys) %>
            </td>
          </tr>
          <tr>
            <th class="text-left px-2 py-0.5 bg-gray-200 border-1 border-t-0">
              <%= t("views.organization.completion_snapshots.invoice.seller_details.phone_label") %>
            </th>
            <td class="px-2 py-0.5 text-right border-1 border-t-0 border-l-0">
              <%= @invoice.payload.dig("seller", "phone") %>
            </td>
          </tr>
          <tr>
            <th class="text-left px-2 py-0.5 bg-gray-200 border-1 border-t-0 rounded-bl">
              <%= t("views.organization.completion_snapshots.invoice.seller_details.siret_label") %>
            </th>
            <td class="px-2 py-0.5 text-right border-1 border-t-0 border-l-0 rounded-br">
              <%= @invoice.payload.dig("seller", "siret") %>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="flex justify-between gap-4 mb-8">
        <table class="grow">
          <tbody>
            <tr>
              <th colspan="2" class="px-2 py-1 bg-gray-200 border-1 rounded rounded-b-none">
                <%= t("views.organization.completion_snapshots.invoice.billing_address.title") %>
              </th>
            </tr>
            <tr>
              <td class="px-2 py-1 border-1 border-t-0 rounded-b">
                <strong><%= @invoice.payload.dig("billing_address", "name") %></strong><br>
                <%= t("common.address.value", **@invoice.payload.dig("billing_address", "address").symbolize_keys) %>
              </td>
            </tr>
          </tbody>
        </table>
        <table class="grow">
          <tbody>
            <tr>
              <th colspan="2" class="px-2 py-1 bg-gray-200 border-1 rounded rounded-b-none">
                <%= t("views.organization.completion_snapshots.invoice.delivery_address.title") %>
              </th>
            </tr>
            <tr>
              <td class="px-2 py-1 border-1 border-t-0 rounded-b">
                <strong><%= @invoice.payload.dig("delivery_address", "name") %></strong><br>
                <%= t("common.address.value", **@invoice.payload.dig("delivery_address", "address").symbolize_keys) %>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <table class="w-full">
        <tbody>
          <tr>
            <th colspan="2" class="px-2 py-1 bg-gray-200 border rounded rounded-b-none">
              <%= t("views.organization.completion_snapshots.invoice.context.title") %>
            </th>
          </tr>
          <tr>
            <td class="px-2 py-1 border-1 border-t-0 rounded-b">
              <%= t("views.organization.completion_snapshots.invoice.context.project_html",
                    name: @invoice.payload.dig("project_context", "name")) %><br>
              <%= t("views.organization.completion_snapshots.invoice.context.project_version_html",
                    version_number: @invoice.payload.dig("project_context", "version", "number"),
                    version_date: l(DateTime.parse(@invoice.payload.dig("project_context", "version", "date")))) %><br>
              <%= t("views.organization.completion_snapshots.invoice.context.project_total_html",
                    total: number_to_currency(@invoice.payload.dig("project_context", "total_amount"))) %><br>
              <%= t("views.organization.completion_snapshots.invoice.context.project_previously_billed_html",
                    previously_billed: number_to_currency(@invoice.payload.dig("project_context", "previously_billed_amount"))) %><br>
              <%= t("views.organization.completion_snapshots.invoice.context.project_remaining_html",
                    remaining: number_to_currency(@invoice.payload.dig("project_context", "remaining_amount"))) %>
            </td>
          </tr>
        </tbody>
      </table>
    </section>

    <% @invoice.payload.dig("transaction", "item_groups").map do |item_group| %>
      <%= render "organization/completion_snapshots/item_group", item_group: item_group, payload: @invoice.payload %>
    <% end %>
    <%= render "organization/completion_snapshots/invoice_total", payload: @invoice.payload %>

    <section class="break-before-page">
      <h1 class="text-center text-xl font-bold">Condition generales de ventes</h1>
      <p>
        Le vendeur se réserve la propriété des marchandises vendues jusqu'au complet paiement du prix,
        conformément à la Loi N° 80-335 du 12 mai 1980
      </p>
      <p>
        Délai de réglement selon loi L.ME, Pénalités de retard en cas de palement après échéance équivalentes
        à 3 fois le taux d'intérêt légal, indemnite forfaitaire pour frais de recouvrement de 40€.
        Pas d'ecomple en cas de paiement anticipé
      </p>
    </section>
  </main>
<% end %>
